<!DOCTYPE html>
<html>
<head>
    <title>Social Media Automation</title>
</head>
<body>
    <h1>Social Media Automation</h1>
    <p>A tool for automating social media content posting across multiple platforms.</p>
    
    <!-- TikTok Login Button -->
    <div id="tiktok-login-container">
        <button onclick="loginWithTikTok()">Login with TikTok</button>
    </div>
    
    <!-- Upload Form (initially hidden) -->
    <div id="upload-form" style="display: none;">
        <h2>Upload Video to TikTok</h2>
        <form id="video-upload-form">
            <input type="file" id="video-file" accept="video/*" required><br><br>
            <input type="text" id="description" placeholder="Video description"><br><br>
            <input type="text" id="hashtags" placeholder="Hashtags (comma separated)"><br><br>
            <select id="visibility">
                <option value="private">Only me</option>
                <option value="public">Public</option>
            </select><br><br>
            <button type="submit">Upload Video</button>
        </form>
    </div>

    <ul>
        <li><a href="TERMS">Terms of Service</a></li>
        <li><a href="PRIVACY">Privacy Policy</a></li>
    </ul>

    <script>
        function generateState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        function loginWithTikTok() {
            const clientKey = "awdmgl4x0u4626up";
            const redirectUri = "https://nassermendes.github.io/social-media-automation/callback";
            const scope = "user.info.basic,video.upload";
            const state = generateState();
            
            // Store state in localStorage to verify on callback
            localStorage.setItem("tiktok_auth_state", state);
            
            // Build the authorization URL with proper encoding
            const baseUrl = "https://www.tiktok.com/v2/auth/authorize/";
            const params = {
                client_key: clientKey,
                redirect_uri: redirectUri,
                scope: scope,
                response_type: "code",
                state: state
            };

            // Convert params to query string with proper encoding
            const queryString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join("&");

            const authUrl = `${baseUrl}?${queryString}`;
            console.log("Auth URL:", authUrl);
            
            // For debugging
            const decodedUrl = decodeURIComponent(authUrl);
            console.log("Decoded URL:", decodedUrl);
            
            // Redirect to TikTok auth page
            window.location.href = authUrl;
        }

        // Check if we are returning from TikTok auth
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get("code");
            const state = urlParams.get("state");
            
            if (code) {
                // Verify state to prevent CSRF
                const savedState = localStorage.getItem("tiktok_auth_state");
                if (state !== savedState) {
                    console.error("State mismatch - possible CSRF attack");
                    document.body.innerHTML += "<p style=\"color: red;\">Error: Invalid state parameter</p>";
                    return;
                }
                
                console.log("Received auth code:", code);
                // Store the auth code
                localStorage.setItem("tiktok_auth_code", code);
                // Clear the state
                localStorage.removeItem("tiktok_auth_state");
                // Show the upload form
                document.getElementById("upload-form").style.display = "block";
                // Hide the login button
                document.getElementById("tiktok-login-container").style.display = "none";
            }
        };
    </script>
</body>
</html>
